# =============================================================================
# Dockerfile.torch.dev.mac - PyTorch Development Container for macOS
# =============================================================================
# Supports both Apple Silicon (arm64) and Intel (amd64) Macs
# NOTE: GPU acceleration via MPS is NOT available inside Docker containers.
#       Docker on macOS uses virtualization which lacks GPU API access.
#       For GPU-accelerated training, run PyTorch natively on macOS.
# =============================================================================

FROM mcr.microsoft.com/vscode/devcontainers/python:dev-3.11-bookworm

# Build arguments
ARG UV_EXTRA=cpu
ARG WORKSPACE_DIR=/workspaces/eng-ai-agents
ARG WORKSPACE_USER=vscode
ARG TARGETARCH

# Environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV UV_EXTRA=${UV_EXTRA}
ENV WORKSPACE_DIR=${WORKSPACE_DIR}
ENV WORKSPACE_USER=${WORKSPACE_USER}

# Install base dependencies with cache mount
RUN --mount=type=cache,target=/var/lib/apt/lists \
    --mount=type=cache,target=/var/cache/apt/archives \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        unzip && \
    rm -rf /var/lib/apt/lists/*

# Install development packages
RUN apt-get clean && \
    apt-get update && \
    apt-get install -y --no-install-recommends --fix-missing \
        build-essential binutils \
        cmake curl \
        dbus-x11 \
        ffmpeg \
        gdb gcc g++ gfortran git git-lfs \
        tar \
        lsb-release \
        procps \
        make \
        bash-completion \
        manpages-dev \
        unzip \
        zip \
        wget \
        xauth \
        swig \
        coreutils \
        util-linux \
        openssh-client \
        python3-pip python3-dev python3-numpy python3-venv \
        python3-setuptools python3-pyqt5 python3-opencv \
        libboost-python-dev libboost-thread-dev libatlas-base-dev libavcodec-dev \
        libavformat-dev libavutil-dev libcanberra-gtk3-module libeigen3-dev \
        libglew-dev libgl1-mesa-dev libgl1 libgl1-mesa-glx libglib2.0-0 libgtk2.0-dev \
        libgtk-3-dev libjpeg-dev liblapack-dev \
        liblapacke-dev libopenblas-dev libopencv-dev libpng-dev libpostproc-dev \
        libpq-dev libsm6 libswscale-dev libtbb-dev libtesseract-dev \
        libtiff-dev libv4l-dev libx11-dev libxext6 libxine2-dev \
        libxrender-dev libxvidcore-dev libx264-dev libgtkglext1 libgtkglext1-dev \
        libvtk9-dev libdc1394-dev libgstreamer-plugins-base1.0-dev \
        libgstreamer1.0-dev libopenexr-dev \
        openexr \
        pkg-config \
        qv4l2 \
        v4l-utils \
        zlib1g-dev \
        locales \
        graphviz \
        graphviz-dev \
    && locale-gen en_US.UTF-8 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Upgrade pip and install base Python packages
RUN pip3 install --no-cache-dir \
        pip \
        setuptools \
        wheel \
        cython

# Install PyTorch (CPU-only for Docker on macOS)
# NOTE: MPS backend requires native macOS, not Docker
RUN pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# Copy the constraint file - we respect the existing package versions
RUN mkdir -p /etc/pip && \
    pip list --format=freeze > /etc/pip/constraint.txt

# Install UV for modern Python package management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Install Node.js (required for some Quarto extensions)
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install Quarto - dynamically select architecture
RUN QUARTO_ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -LO https://quarto.org/download/latest/quarto-linux-${QUARTO_ARCH}.deb && \
    dpkg -i quarto-linux-${QUARTO_ARCH}.deb && \
    rm quarto-linux-${QUARTO_ARCH}.deb

# Install 1Password CLI - dynamically select architecture
RUN OP_ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | gpg --dearmor > /usr/share/keyrings/1password-archive-keyring.gpg && \
    echo "deb [arch=${OP_ARCH} signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/${OP_ARCH} stable main" > /etc/apt/sources.list.d/1password.list && \
    apt-get update && \
    apt-get install -y 1password-cli && \
    rm -rf /var/lib/apt/lists/*

# Set up workspace
WORKDIR ${WORKSPACE_DIR}

# Switch to non-root user
USER vscode

# Disable GPG signing for git commits
RUN git config --global commit.gpgsign false

# Set up git completion
RUN echo "source /usr/share/bash-completion/completions/git" >> ~/.bashrc
