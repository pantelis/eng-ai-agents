# =============================================================================
# Dockerfile.ros.dev.mac - ROS 2 Jazzy Development Container for macOS
# =============================================================================
# Supports both Apple Silicon (arm64) and Intel (amd64) Macs
# NOTE: RViz2 GUI requires XQuartz on macOS. Install with: brew install xquartz
#       Enable "Allow connections from network clients" in XQuartz preferences.
# =============================================================================

ARG ROS_DISTRO=jazzy
ARG FROM_IMAGE=ros:${ROS_DISTRO}-ros-base
ARG UV_EXTRA=cpu
ARG WORKSPACE_DIR=/workspaces/eng-ai-agents
ARG WORKSPACE_USER=vscode
ARG TARGETARCH

FROM ${FROM_IMAGE} AS builder

# Environment variables for display and ROS
ENV QT_X11_NO_MITSHM=1
ENV EDITOR=nano
ENV XDG_RUNTIME_DIR=/tmp
# ROS 2 discovery settings for Docker on macOS
ENV ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
ENV ROS_DOMAIN_ID=42

# Install development packages
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    curl \
    lsb-release \
    gnupg \
    git \
    git-lfs \
    wget \
    unzip \
    zip \
    ffmpeg \
    bash-completion \
    make \
    libglu1-mesa-dev \
    nano \
    python3-pip \
    python3-venv \
    python3-dev \
    python3-numpy \
    python3-setuptools \
    python3-pyqt5 \
    python3-opencv \
    python3-pydantic \
    python3-catkin-pkg \
    python3-argcomplete \
    python3-colcon-common-extensions \
    ament-cmake \
    clang \
    clang-format \
    clang-tidy \
    ros-${ROS_DISTRO}-ament-cmake \
    ros-${ROS_DISTRO}-joint-state-publisher \
    ros-${ROS_DISTRO}-robot-localization \
    ros-${ROS_DISTRO}-plotjuggler-ros \
    ros-${ROS_DISTRO}-robot-state-publisher \
    ros-${ROS_DISTRO}-ros2bag \
    ros-${ROS_DISTRO}-rosbag2-storage-default-plugins \
    ros-${ROS_DISTRO}-rqt-tf-tree \
    ros-${ROS_DISTRO}-rmw-fastrtps-cpp \
    ros-${ROS_DISTRO}-rmw-cyclonedds-cpp \
    ros-${ROS_DISTRO}-slam-toolbox \
    ros-${ROS_DISTRO}-turtlebot3 \
    ros-${ROS_DISTRO}-turtlebot3-msgs \
    ros-${ROS_DISTRO}-twist-mux \
    ros-${ROS_DISTRO}-usb-cam \
    ros-${ROS_DISTRO}-xacro \
    ros-${ROS_DISTRO}-tf-transformations \
    ros-${ROS_DISTRO}-foxglove-bridge \
    ruby-dev \
    tmux \
    xorg-dev \
    libboost-python-dev \
    libboost-thread-dev \
    libavcodec-dev \
    libavformat-dev \
    libavutil-dev \
    libcanberra-gtk3-module \
    libeigen3-dev \
    libglew-dev \
    libgl1 \
    libglx-mesa0 \
    libglib2.0-0 \
    libgtk2.0-dev \
    libgtk-3-dev \
    libjpeg-dev \
    liblapack-dev \
    liblapacke-dev \
    libopenblas-dev \
    libopencv-dev \
    libpng-dev \
    libpostproc-dev \
    libpq-dev \
    libsm6 \
    libswscale-dev \
    libtbb-dev \
    libtesseract-dev \
    libtiff-dev \
    libv4l-dev \
    libx11-dev \
    libxext6 \
    libxine2-dev \
    libxrender-dev \
    libxvidcore-dev \
    libx264-dev \
    libgtkglext1 \
    libgtkglext1-dev \
    libvtk9-dev \
    libdc1394-dev \
    libgstreamer-plugins-base1.0-dev \
    libgstreamer1.0-dev \
    libopenexr-dev \
    openexr \
    pkg-config \
    qv4l2 \
    v4l-utils \
    zlib1g-dev \
    locales \
    openssh-client \
    && locale-gen en_US.UTF-8 \
    && rm -rf /var/lib/apt/lists/*

# OpenGL libraries for GUI applications
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update \
    && apt-get install -y -qq --no-install-recommends \
        libglvnd0 \
        libgl1 \
        libglx0 \
        libegl1 \
        libxext6 \
        libx11-6 \
    && apt-get autoremove -y \
    && apt-get clean -y \
    && rm -rf /var/lib/apt/lists/*
ENV DEBIAN_FRONTEND=dialog

RUN apt-get autoremove -y \
    && apt-get clean -y \
    && rm -rf /var/lib/apt/lists/*

# Install tmuxinator
RUN gem install tmuxinator && \
    wget https://raw.githubusercontent.com/tmuxinator/tmuxinator/master/completion/tmuxinator.bash -O /etc/bash_completion.d/tmuxinator.bash

# Create non-root user
ARG USER_UID=1001
ARG USER_GID=1001

RUN groupadd --gid $USER_GID vscode \
    && useradd -s /bin/bash --uid $USER_UID --gid $USER_GID -m vscode \
    && apt-get update \
    && apt-get install -y sudo \
    && echo vscode ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/vscode \
    && chmod 0440 /etc/sudoers.d/vscode \
    && rm -rf /var/lib/apt/lists/* \
    && echo "source /usr/share/bash-completion/completions/git" >> /home/vscode/.bashrc

# Add vscode user to input group for joystick access
RUN groupadd -g 107 input 2>/dev/null || true && usermod -aG input vscode

USER vscode

# Configure shell environment
RUN echo "export DISABLE_AUTO_TITLE=true" >> ~/.bashrc && \
    echo 'LC_NUMERIC="en_US.UTF-8"' >> ~/.bashrc && \
    echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> ~/.bashrc

# ROS aliases
RUN echo 'alias rosdi="rosdep install --from-paths src --ignore-src --rosdistro=${ROS_DISTRO} -y"' >> ~/.bashrc && \
    echo 'alias cbuild="colcon build --symlink-install"' >> ~/.bashrc && \
    echo 'alias ssetup="source ./install/local_setup.bash"' >> ~/.bashrc && \
    echo 'alias cyclone="export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp"' >> ~/.bashrc && \
    echo 'alias fastdds="export RMW_IMPLEMENTATION=rmw_fastrtps_cpp"' >> ~/.bashrc && \
    echo 'export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp' >> ~/.bashrc

# Colcon setup
RUN echo 'eval "$(register-python-argcomplete ros2)"' >> ~/.bashrc && \
    echo 'eval "$(register-python-argcomplete colcon)"' >> ~/.bashrc && \
    echo "source /usr/share/colcon_cd/function/colcon_cd.sh" >> ~/.bashrc && \
    echo "export _colcon_cd_root=/opt/ros/${ROS_DISTRO}/" >> ~/.bashrc && \
    echo "source /usr/share/colcon_argcomplete/hook/colcon-argcomplete.bash" >> ~/.bashrc

# Python aliases
RUN echo 'alias python="python3"' >> ~/.bashrc && \
    echo 'alias pip="pip3"' >> ~/.bashrc

# Install UV for modern Python package management (as root)
USER root
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Copy the constraint file
RUN mkdir -p /etc/pip && \
    pip list --format=freeze > /etc/pip/constraint.txt

# Install Node.js (required for some Quarto extensions)
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install Quarto - dynamically select architecture
ARG TARGETARCH
RUN QUARTO_ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -LO https://quarto.org/download/latest/quarto-linux-${QUARTO_ARCH}.deb && \
    dpkg -i quarto-linux-${QUARTO_ARCH}.deb && \
    rm quarto-linux-${QUARTO_ARCH}.deb

# Install 1Password CLI - dynamically select architecture
RUN OP_ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | gpg --dearmor > /usr/share/keyrings/1password-archive-keyring.gpg && \
    echo "deb [arch=${OP_ARCH} signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/${OP_ARCH} stable main" > /etc/apt/sources.list.d/1password.list && \
    apt-get update && \
    apt-get install -y 1password-cli && \
    rm -rf /var/lib/apt/lists/*

# Switch back to vscode user
USER vscode

# Disable GPG signing for git commits
RUN git config --global commit.gpgsign false

# Set up workspace
ARG WORKSPACE_DIR
WORKDIR ${WORKSPACE_DIR}
RUN echo "if [ -f ${WORKSPACE_DIR}/install/setup.bash ]; then source ${WORKSPACE_DIR}/install/setup.bash; fi" >> ~/.bashrc && \
    echo 'if [ -f /workspaces/eng-ai-agents/ros_ws/install/setup.bash ]; then source /workspaces/eng-ai-agents/ros_ws/install/setup.bash; fi' >> ~/.bashrc

ENV PYTHONUNBUFFERED=True
